---
import MainLayout from '../../layouts/MainLayout.astro';
import { ViewTransitions } from 'astro:transitions';
import { SignInForm } from '../../components/auth/SignInForm';
import { logger } from '../../lib/services/logger.service';

logger.debug('Rendering login page');

const { user, supabase } = Astro.locals;
const isLogout = Astro.url.searchParams.has('logout');

if (isLogout) {
  const cookiesToDelete = [
    'sb-access-token',
    'sb-refresh-token',
    'supabase-auth-token',
    'session',
    'supabase-auth-token-name',
    'sb-127-auth-token',
    'sb-localhost-auth-token'
  ];
  
  cookiesToDelete.forEach(name => {
    Astro.cookies.delete(name, { path: '/' });
  });
}

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');
const supabaseAuthToken = Astro.cookies.get('supabase-auth-token');

logger.debug('Login page loaded, checking cookies:');
logger.debug('- Has user in locals:', !!user);
logger.debug('- Has access token cookie:', !!accessToken);
logger.debug('- Has refresh token cookie:', !!refreshToken);
logger.debug('- Has supabase auth token cookie:', !!supabaseAuthToken);
logger.debug('- All cookies:', Astro.request.headers.get('cookie'));

if (accessToken && refreshToken && supabase && !isLogout) {
  try {
    const { data, error } = await supabase.auth.getUser();
    logger.debug('Supabase getUser result:', { hasUser: !!data.user, error });
    
    if (data.user) {
      logger.debug('Valid user detected, redirecting to /flashcards');
      return Astro.redirect('/flashcards');
    }
  } catch (err) {
    logger.error('Error checking user session:', err);
  }
}

if (user && !isLogout) {
  logger.debug('User in locals, redirecting to /flashcards');
  return Astro.redirect('/flashcards');
}
---

<MainLayout title="Logowanie">
  <ViewTransitions />
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-md mx-auto" data-testid="login-page-container">
      <div style="position: relative; z-index: 10; visibility: visible; display: block;">
        <SignInForm client:load />
      </div>
      <div class="mt-4 text-center">
        <a href="/auth/signup" class="text-blue-600 hover:underline" data-testid="switch-to-register">
          Nie masz konta? Zarejestruj siÄ™
        </a>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { logger } from '../../lib/services/logger.service';

  function deleteAllCookies() {
    const cookies = document.cookie.split(';');
    
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i];
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.substring(0, eqPos).trim() : cookie.trim();
      
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;secure`;
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${window.location.hostname}`;
    }
  }

  if (window.location.search.includes('logout')) {
    logger.debug('Logout detected, clearing all cookies client-side');
    deleteAllCookies();
    window.history.replaceState({}, document.title, window.location.pathname);
  }
</script> 